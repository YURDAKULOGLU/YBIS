# Epic 3: Closed Beta Backend Foundation (REVISED - COMPREHENSIVE)

**ID:** 3  
**Status:** Draft  
**Owner:** @ybis-team  
**Created:** 2025-10-29  
**Revised:** 2025-10-29 03:14 UTC  
**Target:** Closed Beta Launch (Week 1-7)

---

## 🎯 1. Epic Goal

Closed Beta için **production-ready backend infrastructure** oluşturmak:
- ✅ Supabase BaaS (Auth + Database + Storage + Vector)
- ✅ Hono API server (Edge Functions - Vercel)
- ✅ Port Architecture (AuthPort, DatabasePort, LLMPort, StoragePort)
- ✅ Security (JWT, RLS, Rate Limiting, Input Validation)
- ✅ Monitoring (Logging, Error Tracking)
- ✅ Deployment (DeploymentPort → VercelEdgeAdapter)

**Zero-Tolerance Compliance:**
- All backend code MUST follow `YBIS_PROJE_ANAYASASI.md`
- Port Architecture MANDATORY (no direct vendor SDK usage)
- TypeScript strict mode (no `any`, no `@ts-ignore`)
- 80%+ test coverage (unit + integration)
- API schema validation (Zod) MANDATORY

---

## 2. Scope (Kapsam)

### **Backend Infrastructure (NEW - Detaylı!):**
- ✅ Supabase project setup (prod + dev)
- ✅ Supabase client configuration (connection pooling, RLS context)
- ✅ Database migrations (tracked in `supabase/migrations/`)
- ✅ Row Level Security (RLS) policies (workspace isolation)
- ✅ Realtime subscriptions (postgres_changes channels)
- ✅ Edge Functions (Supabase Functions or Vercel Edge)

### **Authentication (Enhanced):**
- ✅ Google OAuth (Supabase provider)
- ✅ Email/Password Auth (Supabase email provider)
- ✅ AuthPort + SupabaseAuthAdapter (full implementation)
- ✅ JWT validation middleware (Hono)
- ✅ Session management (expo-secure-store client, Supabase server)
- ✅ Token refresh automation

### **Core Data Management (Expanded):**
- ✅ DatabasePort + SupabaseDatabaseAdapter (full implementation)
- ✅ Notes API (CRUD + Realtime + Search)
- ✅ Tasks API (CRUD + Realtime + Status/Priority filters)
- ✅ Flows API (CRUD + Realtime + Step execution metadata)
- ✅ Workspace isolation (RLS + API middleware)
- ✅ Optimistic updates (client-side with conflict resolution)

### **API Layer (NEW - Critical!):**
- ✅ Hono routes (`/api/auth`, `/api/notes`, `/api/tasks`, `/api/flows`)
- ✅ Request validation (Zod schemas)
- ✅ Error handling middleware (typed errors)
- ✅ CORS configuration (mobile app whitelist)
- ✅ Rate limiting (100 req/min per user)
- ✅ Logging middleware (structured logs)

### **Security (NEW - Mandatory!):**
- ✅ JWT validation (Supabase Auth tokens)
- ✅ Workspace isolation enforcement (middleware)
- ✅ Input sanitization (Zod + DOMPurify)
- ✅ SQL injection prevention (Supabase parameterized queries)
- ✅ XSS prevention (sanitized responses)
- ✅ Rate limiting (Redis-based or in-memory)

### **Monitoring & Observability (NEW):**
- ✅ Structured logging (`@ybis/logging` package)
- ✅ Error tracking (Sentry backend integration)
- ✅ Performance monitoring (API response times)
- ✅ Database query performance (Supabase dashboard)

### **Deployment (NEW - DeploymentPort!):**
- ✅ DeploymentPort interface
- ✅ VercelEdgeAdapter implementation
- ✅ Environment variables management (`.env.local`, Vercel dashboard)
- ✅ Cold start optimization (<100ms)
- ✅ Edge Function deployment workflow

### **NOT in Scope (Future Epics):**
- ❌ Google Calendar integration (Epic 7)
- ❌ RAG system (Epic 8)
- ❌ AI Tool Calling (Epic 9)
- ❌ Push notifications backend (Story 3.9 - separate)
- ❌ Background jobs (Supabase cron)
- ❌ File upload API (StoragePort - future)

---

## 3. Risk Analysis (Updated)

**Risk 1 (High): Supabase Free Tier Limits**
- Database: 500MB, Realtime: 200 connections, Bandwidth: 2GB/mo
- **Mitigation:** 
  - Monitor usage daily (Supabase dashboard)
  - Optimize queries (indexes, pagination)
  - Upgrade to Pro ($25/mo) if usage >80%
  - Alert at 90% threshold

**Risk 2 (High): RLS Policy Bugs → Data Leakage**
- Incorrectly configured RLS = user A sees user B's data
- **Mitigation:**
  - Peer review ALL RLS policies (2 reviewers minimum)
  - Integration tests with 3+ test users
  - Manual pentest (attempt to access other workspace)
  - Automated RLS tests in CI/CD

**Risk 3 (Medium): JWT Token Expiry → User Logout Loop**
- Supabase JWT expires every 60 min, refresh token needed
- **Mitigation:**
  - Implement auto-refresh in SupabaseAuthAdapter
  - Client-side token refresh (15 min before expiry)
  - Retry failed requests after refresh

**Risk 4 (Medium): Edge Function Cold Start Latency**
- Vercel Edge cold start: 50-200ms (acceptable)
- Too many functions = more cold starts
- **Mitigation:**
  - Single Edge Function endpoint (Hono router inside)
  - Keep bundle size <1MB (tree-shaking)
  - Monitor P95 latency (Vercel analytics)

**Risk 5 (Low): API Rate Limiting Too Aggressive**
- 100 req/min might block legitimate power users
- **Mitigation:**
  - Monitor rate limit hits (logging)
  - Adjust limits based on beta feedback
  - Whitelist heavy testers if needed

**Risk 6 (Critical): No Backup Strategy**
- Supabase free tier: Daily backups (7 days retention)
- User loses data = catastrophic
- **Mitigation:**
  - Document backup policy
  - Test restore process (monthly)
  - Upgrade to Pro (Point-in-time recovery)

---

## 4. User Stories (REVISED - 12 Stories!)

### **Backend Infrastructure Stories:**

---

#### **Story 3.1: Supabase Project Setup & Configuration**

**User Story:** Bir developer olarak, Supabase project kurulu ve configured olmalı, böylece backend services implement edebilirim.

**Acceptance Criteria:**
- [ ] Supabase organization "YBIS" created
- [ ] Production project `ybis-closed-beta-prod` setup (eu-west-1)
- [ ] Development project `ybis-closed-beta-dev` setup
- [ ] Google Cloud Console OAuth 2.0 credentials created
- [ ] Supabase Google provider configured
- [ ] Supabase Email provider enabled
- [ ] Redirect URI `ybis://auth-callback` working
- [ ] Environment variables documented in `docs/backend/ENVIRONMENT_VARS.md`
- [ ] Connection pooling configured (max 10 connections)
- [ ] Supabase client initialized in `packages/database/src/client.ts`

**Technical Notes:**
- Use `SUPABASE_SERVICE_ROLE_KEY` only in backend (admin access)
- Use `SUPABASE_ANON_KEY` in mobile (RLS enforced)
- Document all API keys in password manager (1Password/Bitwarden)
- Test connection from mobile app (basic SELECT query)

**Assigned To:** Dev Agent  
**Story Points:** 3  
**Priority:** P0 (Blocker)

---

#### **Story 3.2: Database Schema & RLS Policies**

**User Story:** Bir developer olarak, workspace-based schema ve bulletproof RLS policies olmalı, böylece multi-tenant data isolation garantileyebilirim.

**Acceptance Criteria:**
- [ ] `workspaces` table created with columns:
  - `id uuid PRIMARY KEY`
  - `owner_id uuid REFERENCES auth.users(id)`
  - `name text NOT NULL`
  - `created_at timestamptz DEFAULT now()`
  - `updated_at timestamptz DEFAULT now()`
- [ ] `profiles` table created:
  - `id uuid PRIMARY KEY`
  - `user_id uuid REFERENCES auth.users(id)`
  - `workspace_id uuid REFERENCES workspaces(id)`
  - `display_name text`
  - `avatar_url text`
  - `UNIQUE(user_id, workspace_id)`
- [ ] `notes` table created:
  - `id uuid PRIMARY KEY`
  - `workspace_id uuid REFERENCES workspaces(id)`
  - `user_id uuid REFERENCES auth.users(id)`
  - `title text NOT NULL`
  - `content text`
  - `created_at timestamptz`
  - `updated_at timestamptz`
- [ ] `tasks` table created:
  - `id uuid PRIMARY KEY`
  - `workspace_id uuid REFERENCES workspaces(id)`
  - `user_id uuid REFERENCES auth.users(id)`
  - `title text NOT NULL`
  - `status text CHECK (status IN ('todo', 'in_progress', 'done'))`
  - `priority text CHECK (priority IN ('low', 'medium', 'high'))`
  - `due_date timestamptz`
  - `created_at timestamptz`
  - `updated_at timestamptz`
- [ ] `flows` table created:
  - `id uuid PRIMARY KEY`
  - `workspace_id uuid REFERENCES workspaces(id)`
  - `user_id uuid REFERENCES auth.users(id)`
  - `name text NOT NULL`
  - `steps jsonb NOT NULL DEFAULT '[]'`
  - `created_at timestamptz`
  - `updated_at timestamptz`
- [ ] All tables: RLS enabled
- [ ] RLS policies tested with 3 different users
- [ ] Database trigger: Auto-create workspace on signup
- [ ] Database trigger: Auto-update `updated_at` on row change
- [ ] Indexes created on all foreign keys
- [ ] Migrations tracked in `supabase/migrations/`
- [ ] Migration rollback scripts documented

**Technical Notes:**
- All primary keys: UUID v4 (`gen_random_uuid()`)
- All timestamps: `timestamptz` (UTC)
- Foreign keys: `ON DELETE CASCADE` (cleanup)
- RLS: `workspace_id IN (SELECT id FROM workspaces WHERE owner_id = auth.uid())`
- Test RLS: Create user A, user B, verify user A cannot query user B's data

**Assigned To:** Dev Agent  
**Story Points:** 5  
**Priority:** P0 (Blocker)

---

#### **Story 3.3: AuthPort Package - Full Implementation**

**User Story:** Bir developer olarak, AuthPort fully implemented olmalı, böylece authentication logic tamamen soyutlanmış ve test edilebilir olsun.

**Acceptance Criteria:**
- [ ] `packages/auth/` package created with structure:
  ```
  packages/auth/
  ├── src/
  │   ├── ports/
  │   │   └── AuthPort.ts
  │   ├── adapters/
  │   │   └── SupabaseAuthAdapter.ts
  │   ├── types/
  │   │   ├── AuthSession.ts
  │   │   ├── User.ts
  │   │   └── AuthError.ts
  │   ├── __tests__/
  │   │   └── SupabaseAuthAdapter.test.ts
  │   └── index.ts
  ├── package.json
  └── tsconfig.json
  ```
- [ ] `AuthPort` interface defined with methods:
  ```typescript
  export interface AuthPort {
    signInWithGoogle(): Promise<AuthSession>;
    signInWithEmail(email: string, password: string): Promise<AuthSession>;
    signUpWithEmail(email: string, password: string, displayName: string): Promise<AuthSession>;
    signOut(): Promise<void>;
    getSession(): Promise<AuthSession | null>;
    refreshSession(): Promise<AuthSession>;
    onAuthStateChange(callback: (session: AuthSession | null) => void): () => void;
  }
  ```
- [ ] `SupabaseAuthAdapter` implements all methods
- [ ] Token refresh logic (auto-refresh 15 min before expiry)
- [ ] Error handling (network errors, invalid credentials, etc.)
- [ ] Workspace fetching (after auth, fetch user's workspace)
- [ ] Unit tests: 80%+ coverage
- [ ] Integration tests: Real Supabase instance
- [ ] Mobile app uses AuthPort (NEVER direct Supabase)

**Technical Notes:**
- `AuthSession` type: `{ accessToken, refreshToken, expiresAt, user, workspace }`
- `AuthError` type: `{ code: string, message: string, originalError?: any }`
- Auto-refresh: Use `setTimeout` to refresh token 15 min before expiry
- onAuthStateChange: Use Supabase `onAuthStateChange` listener internally
- Error mapping: Supabase errors → AuthError codes (e.g., "invalid_credentials")

**Assigned To:** Dev Agent  
**Story Points:** 8  
**Priority:** P0 (Blocker)

---

#### **Story 3.4: DatabasePort Package - Full Implementation**

**User Story:** Bir developer olarak, DatabasePort fully implemented olmalı, böylece database operations tamamen soyutlanmış ve test edilebilir olsun.

**Acceptance Criteria:**
- [ ] `packages/database/` package created with structure:
  ```
  packages/database/
  ├── src/
  │   ├── ports/
  │   │   └── DatabasePort.ts
  │   ├── adapters/
  │   │   └── SupabaseDatabaseAdapter.ts
  │   ├── types/
  │   │   ├── DatabaseError.ts
  │   │   └── QueryFilters.ts
  │   ├── __tests__/
  │   │   └── SupabaseDatabaseAdapter.test.ts
  │   └── index.ts
  ├── package.json
  └── tsconfig.json
  ```
- [ ] `DatabasePort` interface defined with methods:
  ```typescript
  export interface DatabasePort {
    query<T>(table: string, filters?: QueryFilters): Promise<T[]>;
    getById<T>(table: string, id: string): Promise<T | null>;
    create<T>(table: string, data: Omit<T, 'id' | 'created_at' | 'updated_at'>): Promise<T>;
    update<T>(table: string, id: string, data: Partial<T>): Promise<T>;
    delete(table: string, id: string): Promise<void>;
    subscribe<T>(table: string, callback: (event: RealtimeEvent<T>) => void): () => void;
  }
  ```
- [ ] `SupabaseDatabaseAdapter` implements all methods
- [ ] RLS context injection (workspace_id from JWT)
- [ ] Realtime subscription (postgres_changes channel)
- [ ] Error handling (database errors → DatabaseError type)
- [ ] Query pagination support (limit, offset)
- [ ] Query ordering support (orderBy, direction)
- [ ] Unit tests: 80%+ coverage (mock Supabase client)
- [ ] Integration tests: Real Supabase instance
- [ ] Mobile app uses DatabasePort (NEVER direct Supabase)

**Technical Notes:**
- `QueryFilters`: `{ eq?: {}, neq?: {}, gt?: {}, lt?: {}, in?: {}, orderBy?: string, limit?: number, offset?: number }`
- `RealtimeEvent<T>`: `{ eventType: 'INSERT' | 'UPDATE' | 'DELETE', new: T, old: T }`
- RLS context: Extract `user_id` and `workspace_id` from JWT, inject into queries
- Error mapping: Supabase `PostgrestError` → `DatabaseError` with user-friendly messages
- Connection pooling: Use Supabase's built-in pooling (max 10 connections)

**Assigned To:** Dev Agent  
**Story Points:** 8  
**Priority:** P0 (Blocker)

---

### **API Layer Stories (NEW!):**

---

#### **Story 3.5: Hono API Server Setup & Middleware**

**User Story:** Bir developer olarak, Hono API server fully configured ve middleware'ler hazır olmalı, böylece API endpoints implement edebilirim.

**Acceptance Criteria:**
- [ ] `apps/backend/src/index.ts` Hono app initialized
- [ ] Middleware stack implemented:
  - `corsMiddleware` (allow mobile app origin)
  - `loggerMiddleware` (structured logging)
  - `errorHandlerMiddleware` (typed error responses)
  - `authMiddleware` (JWT validation)
  - `rateLimitMiddleware` (100 req/min per user)
  - `workspaceMiddleware` (inject workspace_id into context)
- [ ] Route groups created:
  - `/api/auth` (sign in, sign up, sign out, refresh)
  - `/api/notes` (CRUD)
  - `/api/tasks` (CRUD)
  - `/api/flows` (CRUD)
- [ ] Health check endpoint `/api/health` (returns 200)
- [ ] Error response format standardized:
  ```json
  {
    "error": {
      "code": "validation_error",
      "message": "Title is required",
      "details": { "field": "title", "constraint": "required" }
    }
  }
  ```
- [ ] CORS: Allow `ybis://` scheme (mobile app)
- [ ] Rate limiting: 100 requests/min per user (429 Too Many Requests)
- [ ] Logging: All requests logged with duration, status code, user_id

**Technical Notes:**
- Use `hono/cors` for CORS middleware
- Use `hono/logger` for request logging
- JWT validation: Verify Supabase JWT signature with public key
- Rate limiting: In-memory store (Map) with TTL (upgrade to Redis in production)
- Workspace injection: Extract from JWT claims, add to `c.get('workspaceId')`
- Error handler: Catch all exceptions, map to typed errors

**Assigned To:** Dev Agent  
**Story Points:** 5  
**Priority:** P0 (Blocker)

---

#### **Story 3.6: Notes API - CRUD + Realtime**

**User Story:** Bir user olarak, notlarımı create/read/update/delete edebilmeli ve realtime sync olmalı.

**Acceptance Criteria:**
- [ ] `POST /api/notes` - Create note
  - Request body: `{ title: string, content: string }`
  - Response: `{ id, workspace_id, user_id, title, content, created_at, updated_at }`
  - Validation: Zod schema (title required, content optional)
- [ ] `GET /api/notes` - List notes
  - Query params: `limit`, `offset`, `orderBy`, `search`
  - Response: `{ data: Note[], total: number }`
  - Filters: Search by title/content (Supabase full-text search)
- [ ] `GET /api/notes/:id` - Get note by ID
  - Response: `Note` or 404
- [ ] `PATCH /api/notes/:id` - Update note
  - Request body: `{ title?, content? }`
  - Response: Updated `Note`
- [ ] `DELETE /api/notes/:id` - Delete note
  - Response: 204 No Content
- [ ] Realtime subscription: Client subscribes to `notes` table
  - Events: INSERT, UPDATE, DELETE
  - Filtered by workspace_id (RLS)
- [ ] Error handling: 400, 401, 403, 404, 500
- [ ] Integration tests: Full CRUD flow
- [ ] Mobile UI: Notes screen (list, create, edit, delete)

**Technical Notes:**
- Use DatabasePort for all operations
- Validation: Zod schemas in `apps/backend/src/schemas/note.schema.ts`
- Search: Supabase `textSearch` on `title` and `content` columns
- Realtime: Client uses `databasePort.subscribe('notes', callback)`
- Offline: TanStack Query cache (5 min TTL) + optimistic updates

**Assigned To:** Dev Agent  
**Story Points:** 5  
**Priority:** P1 (High)

---

#### **Story 3.7: Tasks API - CRUD + Status/Priority Filters**

**User Story:** Bir user olarak, görevlerimi yönetebilmeli (create, complete, priority) ve realtime sync olmalı.

**Acceptance Criteria:**
- [ ] `POST /api/tasks` - Create task
  - Request body: `{ title: string, status?: string, priority?: string, due_date?: string }`
  - Response: `Task`
  - Validation: status IN ('todo', 'in_progress', 'done'), priority IN ('low', 'medium', 'high')
- [ ] `GET /api/tasks` - List tasks
  - Query params: `status`, `priority`, `limit`, `offset`, `orderBy`
  - Response: `{ data: Task[], total: number }`
  - Filters: status, priority, due_date (today, this_week)
- [ ] `GET /api/tasks/:id` - Get task by ID
- [ ] `PATCH /api/tasks/:id` - Update task
  - Request body: `{ title?, status?, priority?, due_date? }`
  - Response: Updated `Task`
- [ ] `DELETE /api/tasks/:id` - Delete task
- [ ] Realtime subscription: Client subscribes to `tasks` table
- [ ] Error handling: 400, 401, 403, 404, 500
- [ ] Integration tests: Full CRUD flow + filters
- [ ] Mobile UI: Tasks screen enhancements (from Story 2.1)

**Technical Notes:**
- Extend existing Story 2.1 (Tasks screen mock data → real API)
- Due date filters: `due_date::date = CURRENT_DATE` (today), `due_date::date BETWEEN CURRENT_DATE AND CURRENT_DATE + 7` (this week)
- Status: Enum validation in Zod schema
- Priority: Enum validation in Zod schema
- Optimistic updates: TanStack Query mutations

**Assigned To:** Dev Agent  
**Story Points:** 3  
**Priority:** P1 (High)

---

#### **Story 3.8: Flows API - CRUD + Step Metadata**

**User Story:** Bir user olarak, workflow template'lerimi (flows) yönetebilmeliyim.

**Acceptance Criteria:**
- [ ] `POST /api/flows` - Create flow
  - Request body: `{ name: string, steps: Step[] }`
  - Response: `Flow`
  - Validation: steps array of `{ id, type, config }`
- [ ] `GET /api/flows` - List flows
  - Query params: `limit`, `offset`
  - Response: `{ data: Flow[], total: number }`
- [ ] `GET /api/flows/:id` - Get flow by ID
- [ ] `PATCH /api/flows/:id` - Update flow
  - Request body: `{ name?, steps? }`
  - Response: Updated `Flow`
- [ ] `DELETE /api/flows/:id` - Delete flow
- [ ] Realtime subscription: Client subscribes to `flows` table
- [ ] Error handling: 400, 401, 403, 404, 500
- [ ] Integration tests: Full CRUD flow
- [ ] Mobile UI: Flows screen (basic list + create)

**Technical Notes:**
- Steps: Flexible JSON schema (future-proof for complex workflows)
- Example step: `{ id: 'step-1', type: 'send_email', config: { to, subject, body } }`
- Flow execution NOT in this story (future epic)
- Minimal UI: Basic list + create form

**Assigned To:** Dev Agent  
**Story Points:** 3  
**Priority:** P2 (Medium)

---

### **Security Stories (NEW!):**

---

#### **Story 3.9: Email/Password Authentication UI**

**User Story:** Bir user olarak, Google hesabım yoksa email/password ile kayıt olabilmeliyim.

**Acceptance Criteria:**
- [ ] Login screen: Two tabs (Google OAuth, Email/Password)
- [ ] Sign up flow: Email + Password + Display Name
- [ ] Email validation: Valid email format (Zod)
- [ ] Password requirements: Min 8 chars, 1 uppercase, 1 number, 1 special
- [ ] Password visibility toggle (eye icon)
- [ ] Error messages: Clear and helpful
- [ ] "Forgot password?" link (send reset email)
- [ ] AuthPort interface supports both methods (already done in Story 3.3)
- [ ] Mobile UI: Sign up screen + Login screen tabs
- [ ] Email verification optional (disable for beta, enable in production)

**Technical Notes:**
- Email verification: Disabled in beta (enable via Supabase dashboard for production)
- Password reset: Basic flow (send email link, user clicks, reset page)
- Same AuthPort interface for both Google and Email auth
- Store auth method in user metadata (`auth_method: 'google' | 'email'`)

**Assigned To:** Dev Agent  
**Story Points:** 3  
**Priority:** P1 (High)

---

#### **Story 3.10: API Security - JWT Validation & Workspace Isolation**

**User Story:** Bir developer olarak, API endpoints JWT validation ve workspace isolation enforce etmeli, böylece unauthorized access prevent olsun.

**Acceptance Criteria:**
- [ ] `authMiddleware` implemented:
  - Extract JWT from `Authorization: Bearer <token>` header
  - Verify JWT signature (Supabase public key)
  - Decode JWT claims (`sub`, `email`, `user_metadata`)
  - Inject `userId` into context (`c.set('userId', userId)`)
- [ ] `workspaceMiddleware` implemented:
  - Fetch user's workspace from database
  - Inject `workspaceId` into context (`c.set('workspaceId', workspaceId)`)
- [ ] All protected routes use both middlewares
- [ ] Unauthorized requests: 401 Unauthorized
- [ ] Forbidden requests (wrong workspace): 403 Forbidden
- [ ] Unit tests: Mock JWT validation
- [ ] Integration tests: Real JWT tokens
- [ ] Security audit: No endpoint bypasses workspace isolation

**Technical Notes:**
- JWT validation: Use `jose` library (verify RSA signature)
- Supabase public key: Fetch from `https://<project>.supabase.co/.well-known/jwks.json`
- Workspace isolation: ALL queries MUST filter by `workspace_id = c.get('workspaceId')`
- Rate limiting: 100 req/min per `userId` (not IP, to support mobile)

**Assigned To:** Dev Agent  
**Story Points:** 5  
**Priority:** P0 (Blocker - Security Critical!)

---

#### **Story 3.11: Input Validation & Error Handling**

**User Story:** Bir developer olarak, API inputs validated ve errors properly handled olmalı, böylece security vulnerabilities prevent olsun.

**Acceptance Criteria:**
- [ ] All API endpoints use Zod schemas for validation
- [ ] Zod schemas defined in `apps/backend/src/schemas/`:
  - `note.schema.ts`
  - `task.schema.ts`
  - `flow.schema.ts`
  - `auth.schema.ts`
- [ ] Validation errors: 400 Bad Request with details
  - Example: `{ error: { code: 'validation_error', message: 'Title is required', details: { field: 'title' } } }`
- [ ] SQL injection prevention: Supabase parameterized queries (automatic)
- [ ] XSS prevention: Sanitize HTML content (DOMPurify)
- [ ] Error handling middleware catches all exceptions
- [ ] Internal errors: 500 Internal Server Error (hide stack trace in production)
- [ ] Unit tests: Test validation errors
- [ ] Integration tests: Test error responses

**Technical Notes:**
- Zod schemas: Define once, reuse in routes
- Validation: Use Zod `.parse()` method, catch errors
- Error response format: Standardized JSON structure
- Logging: Log all errors to Sentry (backend integration)
- DOMPurify: Sanitize `content` fields (notes, tasks)

**Assigned To:** Dev Agent  
**Story Points:** 3  
**Priority:** P1 (High - Security Critical!)

---

### **Deployment Stories (NEW!):**

---

#### **Story 3.12: Vercel Edge Deployment - DeploymentPort**

**User Story:** Bir developer olarak, backend Vercel Edge'e deploy edilebilmeli, böylece production-ready API sunabilirim.

**Acceptance Criteria:**
- [ ] `packages/deployment/` package created (DeploymentPort)
- [ ] `DeploymentPort` interface defined:
  ```typescript
  export interface DeploymentPort {
    deploy(config: DeploymentConfig): Promise<DeploymentResult>;
    getStatus(): Promise<DeploymentStatus>;
  }
  ```
- [ ] `VercelEdgeAdapter` implements DeploymentPort
- [ ] `vercel.json` configuration:
  - Edge Functions enabled
  - Environment variables configured
  - Build output configured
- [ ] Environment variables:
  - `SUPABASE_URL`
  - `SUPABASE_ANON_KEY`
  - `SUPABASE_SERVICE_ROLE_KEY` (backend only)
  - `JWT_SECRET` (for Supabase JWT verification)
- [ ] Cold start optimization (<100ms)
- [ ] Bundle size optimization (<1MB)
- [ ] Deployment workflow documented in `docs/backend/DEPLOYMENT.md`
- [ ] CI/CD: Auto-deploy on `main` branch push
- [ ] Monitoring: Vercel analytics enabled

**Technical Notes:**
- Vercel Edge: Run on Cloudflare Workers (global edge network)
- Cold start: Minimal dependencies, tree-shaking
- Bundle size: Use `esbuild` for bundling (fast + small)
- Environment variables: Set via Vercel dashboard (production + preview)
- CI/CD: Vercel GitHub integration (auto-deploy)

**Assigned To:** Dev Agent  
**Story Points:** 5  
**Priority:** P1 (High)

---

## 5. Success Metrics (Updated)

**Technical Metrics:**
- ✅ All ports implemented with 80%+ test coverage
- ✅ Authentication flow < 3s (Google + Email)
- ✅ CRUD operations < 500ms (P95)
- ✅ Realtime sync latency < 500ms
- ✅ API error rate < 1%
- ✅ Zero critical bugs in Supabase integration
- ✅ Zero security vulnerabilities (SQL injection, XSS, etc.)
- ✅ Edge Function cold start < 100ms
- ✅ Bundle size < 1MB

**User Metrics:**
- ✅ 80% users choose Google OAuth (primary path)
- ✅ 20% users choose Email/Password (fallback)
- ✅ Zero data leakage between workspaces (RLS working)
- ✅ User satisfaction with API speed >4.5/5

**Security Metrics:**
- ✅ Zero unauthorized access attempts succeed
- ✅ Zero SQL injection vulnerabilities
- ✅ Zero XSS vulnerabilities
- ✅ 100% of API endpoints have JWT validation
- ✅ 100% of API endpoints have input validation

---

## 6. Dependencies & Blockers (Updated)

**Dependencies:**
- ✅ Epic 1: Tier 1 Port Architecture (completed)
- ✅ Story 1.1: Mobile App Foundation (completed)
- ✅ Google Cloud Console access (OAuth credentials)
- ✅ Supabase account (with billing method for upgrades)
- ✅ Vercel account (for Edge Functions deployment)
- ✅ Sentry account (for error monitoring)

**Blockers:**
- ❌ None (all dependencies ready)

**Enables:**
- Epic 7: Google Calendar Integration (needs AuthPort + API)
- Epic 8: RAG System (needs DatabasePort + vector support)
- Epic 9: AI Tool Calling (needs all CRUD APIs)
- Story 3.9: Push Notifications (needs backend notify endpoint)

---

## 7. Related Documents

- Architecture: `docs/Güncel/Architecture_better.md`
- Tech Stack: `docs/Güncel/tech-stack.md`
- Port Catalog: `docs/YBIS_PROJE_ANAYASASI.md` (Section 8)
- PRD: `docs/prd/PRODUCT_REQUIREMENTS.md`
- Tasks: `docs/Güncel/tasks.md` (T036-T080)
- Development Log: `docs/Güncel/DEVELOPMENT_LOG.md` (AD-001 to AD-041)

---

## 8. Testing Strategy (NEW!)

### **Unit Tests (80%+ Coverage):**
- [ ] AuthPort: Mock Supabase Auth client
- [ ] DatabasePort: Mock Supabase client
- [ ] API routes: Mock DatabasePort
- [ ] Middleware: Mock JWT tokens

### **Integration Tests:**
- [ ] Auth flow: Real Supabase project (dev)
- [ ] Database CRUD: Real Supabase project (dev)
- [ ] Realtime subscriptions: Real Supabase project
- [ ] API endpoints: Real Hono server + Supabase

### **Security Tests:**
- [ ] RLS: Attempt to access other user's data (must fail)
- [ ] JWT: Invalid token (must return 401)
- [ ] Workspace isolation: Wrong workspace_id (must return 403)
- [ ] SQL injection: Attempt SQL injection (must be blocked)

### **Performance Tests:**
- [ ] API latency: All endpoints < 500ms (P95)
- [ ] Realtime latency: < 500ms
- [ ] Cold start: < 100ms
- [ ] Bundle size: < 1MB

---

**Last Updated:** 2025-10-29 03:14 UTC  
**Version:** 2.0.0  
**Status:** COMPREHENSIVE REVISION - READY FOR IMPLEMENTATION

---

## 📝 **CHANGELOG (v1.0 → v2.0):**

**Added:**
- Story 3.5: Hono API Server Setup & Middleware (NEW)
- Story 3.10: API Security - JWT Validation (NEW - CRITICAL!)
- Story 3.11: Input Validation & Error Handling (NEW)
- Story 3.12: Vercel Edge Deployment - DeploymentPort (NEW)
- Section 8: Testing Strategy (NEW)
- Detailed acceptance criteria for all stories (ENHANCED)
- Security risk analysis (ENHANCED)
- Performance metrics (ENHANCED)

**Changed:**
- Story 3.1: Added Supabase client configuration
- Story 3.2: Added database triggers, indexes
- Story 3.3: AuthPort - Full implementation details
- Story 3.4: DatabasePort - Full implementation details
- Story 3.6-3.8: API endpoints - Detailed specs
- Story 3.9: Email/Password Auth - UI focused

**Removed:**
- Vague "backend setup" tasks (replaced with specific stories)
- Incomplete acceptance criteria (now all stories have detailed AC)

---

**READY TO IMPLEMENT!** 🚀
