# Epic 7: RAG System (Document Search & AI Context)

**ID:** 7  
**Status:** Draft  
**Owner:** @ybis-team  
**Created:** 2025-10-29  
**Target:** Closed Beta Launch (Week 6-7)  
**Priority:** P1 (High - AI Quality Critical)

---

## ğŸ¯ 1. Epic Goal

RAG (Retrieval Augmented Generation) sistemi oluÅŸturmak:
- âœ… Document upload & chunking
- âœ… pgvector integration (Supabase)
- âœ… OpenAI embeddings (text-embedding-3-small)
- âœ… Semantic search (top-k similarity)
- âœ… AI context injection (query â†’ relevant chunks â†’ LLM)
- âœ… Source citations (AI response shows document sources)
- âœ… Document management UI

**Closed Beta Scope:**
- âœ… pgvector setup (Supabase extension)
- âœ… Document table (documents, chunks with embeddings)
- âœ… Upload flow (file â†’ chunk â†’ embed â†’ store)
- âœ… Query flow (query â†’ embed â†’ similarity search â†’ top-k)
- âœ… Basic document types: PDF, TXT, MD
- âœ… AI context injection (RAG â†’ LLM prompt)
- âŒ Advanced: OCR, image extraction, web scraping (MVP)

---

## 2. Scope (Kapsam)

### **RAG Infrastructure (P0):**
- âœ… Supabase pgvector extension enabled
- âœ… Tables: `documents`, `chunks` (with embedding vector)
- âœ… RAGPort interface definition
- âœ… SupabaseRAGAdapter implementation
- âœ… OpenAI embeddings API integration

### **Document Processing (P0):**
- âœ… File upload (mobile â†’ backend)
- âœ… Text extraction (PDF, TXT, MD)
- âœ… Chunking strategy (500 tokens, 50 overlap)
- âœ… Embedding generation (OpenAI API)
- âœ… Vector storage (pgvector)

### **Semantic Search (P0):**
- âœ… Query embedding (user query â†’ vector)
- âœ… Similarity search (cosine distance)
- âœ… Top-k retrieval (default: 5 chunks)
- âœ… Relevance scoring (distance threshold)

### **AI Context Injection (P0):**
- âœ… RAG query in chat flow
- âœ… Inject relevant chunks into LLM prompt
- âœ… Source citations in AI response
- âœ… Fallback: No relevant docs â†’ general AI response

### **Document Management UI (P1):**
- âœ… Upload screen (select file â†’ upload)
- âœ… Document list (view all uploaded docs)
- âœ… Document detail (view chunks)
- âœ… Delete document (cascade delete chunks)

### **NOT in Scope:**
- âŒ OCR (image text extraction)
- âŒ Web scraping (URL â†’ document)
- âŒ Advanced chunking (semantic, paragraph-based)
- âŒ Multi-modal embeddings (images + text)
- âŒ Document versioning (MVP)

---

## 3. User Stories (6 Stories - 30 Points)

### **Story 7.1: pgvector Setup & RAGPort Architecture (5 points)**
- Enable pgvector extension (Supabase)
- Create `documents` table
- Create `chunks` table (embedding vector(1536))
- RAGPort interface definition
- SupabaseRAGAdapter skeleton

### **Story 7.2: Document Upload & Text Extraction (5 points)**
- Backend endpoint: `/api/rag/upload` (POST)
- File parsing (PDF, TXT, MD)
- Text extraction (use `pdf-parse`, `marked`)
- Store document metadata in `documents` table

### **Story 7.3: Chunking & Embedding Generation (8 points)**
- Chunking logic (500 tokens, 50 overlap)
- OpenAI embeddings API integration
- Batch embedding (up to 100 chunks)
- Store chunks + embeddings in `chunks` table
- Error handling (embedding API failures)

### **Story 7.4: Semantic Search Implementation (5 points)**
- Query embedding (user query â†’ vector)
- pgvector similarity search (`<->` operator)
- Top-k retrieval (configurable, default 5)
- Relevance threshold (distance <0.3)
- Return chunks with metadata (document_id, content, distance)

### **Story 7.5: AI Context Injection & Citations (5 points)**
- RAG query in chat flow
- Inject top-k chunks into LLM prompt
- Prompt engineering: "Based on these documents: [chunks]"
- Extract source citations from response
- Display citations in UI (expandable section)

### **Story 7.6: Document Management UI (2 points)**
- Upload screen (file picker â†’ upload button)
- Document list screen (uploaded docs)
- Document detail (view chunks preview)
- Delete document (confirm dialog)

---

## 4. Success Metrics

**Technical:**
- âœ… Embedding generation latency <5s per document
- âœ… Query latency <2s (embed + search + LLM)
- âœ… Retrieval accuracy >80% (relevant chunks)
- âœ… Zero pgvector errors

**User:**
- âœ… 50%+ users upload at least 1 document
- âœ… RAG query accuracy >75% (user satisfaction)
- âœ… Average 3 documents per user

**AI Quality:**
- âœ… RAG-enabled responses >80% more accurate
- âœ… Source citation rate >90%

---

**Last Updated:** 2025-10-29  
**Story Points:** 30 (~4-5 hafta)
