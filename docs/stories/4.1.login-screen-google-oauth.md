# Story 4.1: Login Screen with Google OAuth

**Status:** Draft  
**Epic:** 4. Authentication & User Management  
**Story Points:** 5  
**Priority:** P0 (Critical - Blocker)  
**Created:** 2025-10-29  
**Assigned To:** Dev Agent

---

## ğŸ›ï¸ Anayasa Uyum KontrolÃ¼ (ZORUNLU)

- **YBIS Proje AnayasasÄ± Â· Port Architecture - AuthPort (BÃ¶lÃ¼m 3)**  
  Auth logic'i `AuthPort` interface Ã¼zerinden soyutlanacak. Mobile app hiÃ§bir zaman doÄŸrudan Supabase Auth SDK'yÄ± kullanmayacak, sadece `SupabaseAuthAdapter` Ã¼zerinden eriÅŸecek. Demo login seÃ§eneÄŸi de mevcut auth store akÄ±ÅŸÄ±nÄ± kullanacak ve production port mimarisini baypas etmeyecek (yalnÄ±zca mock state tetiklenecek).

- **YBIS Proje AnayasasÄ± Â· UI Ä°zolasyon Prensibi (BÃ¶lÃ¼m 3)**  
  Login screen tÃ¼m UI bileÅŸenlerini `@ybis/ui` paketinden kullanacak. DoÄŸrudan `tamagui` import'u yasak. Demo mode call-to-action'Ä± da aynÄ± komponent katmanÄ±ndan beslenecek.

- **YBIS Proje AnayasasÄ± Â· TypeScript Zero-Tolerance (BÃ¶lÃ¼m 2.1)**  
  Session types, AuthPort interface, tÃ¼m auth service'ler strict TypeScript ile yazÄ±lacak. Yeni hook/deÄŸer eklemelerinde `any` veya bastÄ±rma yapÄ±lmayacak.

## Story

**As a** YBIS user,  
**I want** Google hesabÄ±m ile giriÅŸ yapabilmek,  
**so that** uygulamayÄ± kullanmaya baÅŸlayabilir ve verilerime eriÅŸebilirim.

---

## Context

Bu story, kullanÄ±cÄ±larÄ±n Google OAuth ile giriÅŸ yapmasÄ±nÄ± saÄŸlar. Supabase Auth'u backend olarak kullanÄ±r ama Port Architecture prensibiyle soyutlanmÄ±ÅŸtÄ±r. Login screen, Chat-based ana ekrana yÃ¶nlendirme yapar.

**Dependencies:**
- Story 3.1 (Supabase setup) tamamlanmÄ±ÅŸ olmalÄ±
- Google OAuth configured
- `@ybis/auth` package ready

**References:**
- Architecture: `docs/GÃ¼ncel/Architecture_better.md`
- Auth Flow: AD-015 in `DEVELOPMENT_LOG.md`

---

## Acceptance Criteria

1. **Login Screen UI**
   - Centered layout with YBIS logo
   - "Google ile GiriÅŸ Yap" button
   - Loading state (spinner) during auth
   - Error message display (toast/banner)

2. **AuthPort Package Structure**
   - `packages/auth/` package created
   - `AuthPort` interface defined
   - `SupabaseAuthAdapter` implemented
   - Unit tests for adapter (80%+ coverage)

3. **OAuth Flow Working**
   - Tap Google button â†’ OAuth browser opens
   - Complete Google auth â†’ Redirect to `ybis://auth-callback`
   - Session token saved in `expo-secure-store`
   - User redirected to main app (Chat screen)

4. **Session Management**
   - `authStore` (Zustand) holds session state
   - Session persisted across app restarts
   - Auto-login on app start (if valid session)

5. **Error Handling**
   - Network errors â†’ Retry button
   - OAuth cancelled â†’ Return to login
   - Invalid credentials â†’ Clear error message

6. **Demo Mode Entry (Optional)**
   - â€œDemo Modeâ€ butonu login ekranÄ±nda gÃ¶rÃ¼nÃ¼r
   - TÄ±klandÄ±ÄŸÄ±nda mock demo kullanÄ±cÄ±sÄ± ile uygulama aÃ§Ä±lÄ±r (mevcut demo store kullanÄ±mÄ±)
   - Demo akÄ±ÅŸÄ± aÃ§Ä±kÃ§a â€œDemoâ€ olarak etiketlenir ve gerÃ§ek auth portâ€™una istek atmaz

---

## Tasks / Subtasks

### Task 1: AuthPort Package Setup (AC: 2)
- [ ] **T1.1** Create `packages/auth/package.json`
  ```json
  {
    "name": "@ybis/auth",
    "version": "0.1.0",
    "main": "src/index.ts",
    "dependencies": {
      "@supabase/supabase-js": "^2.47.10"
    }
  }
  ```
- [ ] **T1.2** Create `packages/auth/tsconfig.json` (composite: true)
- [ ] **T1.3** Create `packages/auth/src/ports/AuthPort.ts`
  ```typescript
  export interface AuthSession {
    accessToken: string;
    refreshToken: string;
    user: User;
    workspace: Workspace;
  }

  export interface User {
    id: string;
    email: string;
    displayName: string | null;
    avatarUrl: string | null;
  }

  export interface Workspace {
    id: string;
    name: string;
    ownerId: string;
  }

  export interface AuthPort {
    signInWithGoogle(): Promise<AuthSession>;
    signOut(): Promise<void>;
    getSession(): Promise<AuthSession | null>;
    onAuthStateChange(callback: (session: AuthSession | null) => void): () => void;
  }
  ```
- [ ] **T1.4** Create `packages/auth/src/adapters/SupabaseAuthAdapter.ts`
  - Implement `signInWithGoogle()` using Supabase OAuth
  - Implement `getSession()` with token refresh
  - Implement `onAuthStateChange()` listener
  - Handle errors (network, invalid token)
- [ ] **T1.5** Create unit tests `packages/auth/src/__tests__/SupabaseAuthAdapter.test.ts`
  - Mock Supabase client
  - Test sign in success
  - Test sign in errors
  - Test session retrieval

### Task 2: Login Screen UI (AC: 1)
- [ ] **T2.1** Create `apps/mobile/src/screens/LoginScreen.tsx`
  ```typescript
  import { YStack, Text, Button } from '@ybis/ui';
  import { GoogleIcon } from '@ybis/ui/icons';
  
  export function LoginScreen() {
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState<string | null>(null);
    
    const handleGoogleLogin = async () => {
      // Implement OAuth flow
    };
    
    return (
      <YStack flex={1} alignItems="center" justifyContent="center" padding="$4">
        <YStack gap="$6" maxWidth={400} width="100%">
          {/* Logo */}
          <YStack alignItems="center">
            <Text fontSize="$8" fontWeight="bold">YBIS</Text>
            <Text fontSize="$4" color="$gray11">AI Productivity Assistant</Text>
          </YStack>
          
          {/* Google Login Button */}
          <Button
            size="$5"
            onPress={handleGoogleLogin}
            disabled={loading}
            icon={<GoogleIcon size={24} />}
          >
            {loading ? 'GiriÅŸ yapÄ±lÄ±yor...' : 'Google ile GiriÅŸ Yap'}
          </Button>
          
          {/* Error Display */}
          {error && (
            <Text color="$red10" textAlign="center">{error}</Text>
          )}
        </YStack>
      </YStack>
    );
  }
  ```
- [ ] **T2.2** Add Google icon to `@ybis/ui/icons`
- [ ] **T2.3** Add loading spinner (use Tamagui `Spinner`)

### Task 3: Auth Service Implementation (AC: 3, 4)
- [ ] **T3.1** Create `apps/mobile/src/services/auth.service.ts`
  ```typescript
  import { authPort } from '@ybis/auth';
  import * as SecureStore from 'expo-secure-store';
  
  export class AuthService {
    async signInWithGoogle(): Promise<void> {
      const session = await authPort.signInWithGoogle();
      await this.saveSession(session);
      // Navigate to main app
    }
    
    async saveSession(session: AuthSession): Promise<void> {
      await SecureStore.setItemAsync('auth_session', JSON.stringify(session));
    }
    
    async loadSession(): Promise<AuthSession | null> {
      const json = await SecureStore.getItemAsync('auth_session');
      return json ? JSON.parse(json) : null;
    }
    
    async signOut(): Promise<void> {
      await authPort.signOut();
      await SecureStore.deleteItemAsync('auth_session');
    }
  }
  ```
- [ ] **T3.2** Create Zustand store `apps/mobile/src/stores/authStore.ts`
  ```typescript
  import { create } from 'zustand';
  
  interface AuthState {
    session: AuthSession | null;
    loading: boolean;
    setSession: (session: AuthSession | null) => void;
    setLoading: (loading: boolean) => void;
  }
  
  export const useAuthStore = create<AuthState>((set) => ({
    session: null,
    loading: true,
    setSession: (session) => set({ session }),
    setLoading: (loading) => set({ loading }),
  }));
  ```
- [ ] **T3.3** Implement auto-login in `apps/mobile/app/_layout.tsx`
  ```typescript
  useEffect(() => {
    const checkSession = async () => {
      const session = await authService.loadSession();
      if (session) {
        authStore.setSession(session);
        router.replace('/(tabs)'); // Navigate to main app
      } else {
        authStore.setLoading(false);
      }
    };
    checkSession();
  }, []);
  ```

### Task 4: OAuth Deep Link Handling (AC: 3)
- [ ] **T4.1** Add deep link config to `app.json`
  ```json
  {
    "expo": {
      "scheme": "ybis",
      "android": {
        "intentFilters": [{
          "action": "VIEW",
          "data": [{ "scheme": "ybis" }]
        }]
      },
      "ios": {
        "bundleIdentifier": "com.ybis.mobile",
        "associatedDomains": ["applinks:ybis.app"]
      }
    }
  }
  ```
- [ ] **T4.2** Create `apps/mobile/app/auth-callback.tsx` (redirect handler)
  ```typescript
  import { useEffect } from 'react';
  import { useRouter } from 'expo-router';
  
  export default function AuthCallback() {
    const router = useRouter();
    
    useEffect(() => {
      // Supabase handles token exchange automatically
      // Just redirect to main app
      router.replace('/(tabs)');
    }, []);
    
    return null; // Or loading spinner
  }
  ```

### Task 5: Error Handling (AC: 5)
- [ ] **T5.1** Create `NetworkErrorBanner` component
  ```typescript
  export function NetworkErrorBanner({ error, onRetry }: Props) {
    return (
      <YStack padding="$3" backgroundColor="$red2" borderRadius="$4">
        <Text color="$red10">{error}</Text>
        <Button size="$3" onPress={onRetry} marginTop="$2">Tekrar Dene</Button>
      </YStack>
    );
  }
  ```
- [ ] **T5.2** Add error handling to LoginScreen
  - Network error â†’ Show banner + retry
  - OAuth cancelled â†’ Clear error, return to login
  - Invalid credentials â†’ Show error message

### Task 6: Demo Mode CTA & Flow (AC: 6)
- [ ] **T6.1** Ek â€œDemo Moduâ€ butonunu LoginScreen'e ekle (`@ybis/ui` Button + Demo etiketi)
- [ ] **T6.2** Demo butonu `useMockAuth.loginDemo()` fonksiyonunu tetikler, state gÃ¼ncellenir
- [ ] **T6.3** Demo akÄ±ÅŸÄ±na Ã¶zel telemetry/event log ekleyerek gerÃ§ek auth Ã§aÄŸrÄ±sÄ±nÄ± atlamadÄ±ÄŸÄ±nÄ± doÄŸrula
- [ ] **T6.4** Demo ile giriÅŸ yapÄ±ldÄ±ÄŸÄ±nda ana ekranda â€œDemo Modeâ€ gÃ¶stergesi Ã§Ä±kar

---

## Dev Notes

### Supabase OAuth Flow
1. User taps Google button
2. App calls `supabase.auth.signInWithOAuth({ provider: 'google' })`
3. Supabase opens OAuth browser
4. User completes Google auth
5. Google redirects to `ybis://auth-callback`
6. Supabase intercepts redirect, exchanges code for token
7. App receives session

### Token Storage Security
- Use `expo-secure-store` (encrypted keychain/keystore)
- Never store tokens in AsyncStorage (plain text)
- Never log tokens (Sentry masking)

### Session Refresh
- Supabase auto-refreshes tokens (60 min expiry)
- Adapter listens to refresh events
- authStore updated automatically

---

## Testing

### Manual Testing
- [ ] Tap Google button â†’ OAuth browser opens
- [ ] Complete Google auth â†’ Return to app
- [ ] Verify logged in (see main app)
- [ ] Kill app â†’ Reopen â†’ Auto-login works
- [ ] Logout â†’ Return to login screen
- [ ] Login again â†’ Works

### Unit Tests
```typescript
describe('SupabaseAuthAdapter', () => {
  it('should sign in with Google', async () => {
    const adapter = new SupabaseAuthAdapter(mockClient);
    const session = await adapter.signInWithGoogle();
    expect(session).toBeDefined();
    expect(session.user.email).toBe('test@example.com');
  });
});
```

---

## Files Created/Modified

### New Files
```
packages/auth/
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.ts
â”‚   â”œâ”€â”€ ports/
â”‚   â”‚   â””â”€â”€ AuthPort.ts
â”‚   â”œâ”€â”€ adapters/
â”‚   â”‚   â””â”€â”€ SupabaseAuthAdapter.ts
â”‚   â”œâ”€â”€ types/
â”‚   â”‚   â”œâ”€â”€ AuthSession.ts
â”‚   â”‚   â”œâ”€â”€ User.ts
â”‚   â”‚   â””â”€â”€ Workspace.ts
â”‚   â””â”€â”€ __tests__/
â”‚       â””â”€â”€ SupabaseAuthAdapter.test.ts

apps/mobile/src/
â”œâ”€â”€ screens/
â”‚   â””â”€â”€ LoginScreen.tsx
â”œâ”€â”€ services/
â”‚   â””â”€â”€ auth.service.ts
â”œâ”€â”€ stores/
â”‚   â””â”€â”€ authStore.ts
â””â”€â”€ components/
    â””â”€â”€ NetworkErrorBanner.tsx

apps/mobile/app/
â””â”€â”€ auth-callback.tsx
```

### Modified Files
```
apps/mobile/app/_layout.tsx (auto-login logic)
apps/mobile/app.json (deep link config)
packages/ui/src/icons/index.ts (add GoogleIcon)
```

---

## Dependencies & Blockers

**Dependencies:**
- Story 3.1 (Supabase setup) âœ… Must be complete
- Google OAuth credentials configured

**Blockers:**
- None

**Related Stories:**
- 4.2: Session Management (extends auto-login)
- 4.3: User Profile (uses session data)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-29 | 1.0 | Initial story creation | Copilot |

---

## Dev Agent Record

**Agent Model Used:** _[To be filled]_  
**Completion Notes:** _[To be filled]_  
**File List:** _[To be filled]_

---

## QA Results

_[To be filled by QA Agent]_
