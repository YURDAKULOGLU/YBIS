# Story 4.1: Login Screen with Google OAuth

**Status:** Draft  
**Epic:** 4. Authentication & User Management  
**Story Points:** 5  
**Priority:** P0 (Critical - Blocker)  
**Created:** 2025-10-29  
**Assigned To:** Dev Agent

---

## 🏛️ Anayasa Uyum Kontrolü (ZORUNLU)

- **YBIS Proje Anayasası · Port Architecture - AuthPort (Bölüm 3)**  
  Auth logic'i `AuthPort` interface üzerinden soyutlanacak. Mobile app hiçbir zaman doğrudan Supabase Auth SDK'yı kullanmayacak, sadece `SupabaseAuthAdapter` üzerinden erişecek. Demo login seçeneği de mevcut auth store akışını kullanacak ve production port mimarisini baypas etmeyecek (yalnızca mock state tetiklenecek).

- **YBIS Proje Anayasası · UI İzolasyon Prensibi (Bölüm 3)**  
  Login screen tüm UI bileşenlerini `@ybis/ui` paketinden kullanacak. Doğrudan `tamagui` import'u yasak. Demo mode call-to-action'ı da aynı komponent katmanından beslenecek.

- **YBIS Proje Anayasası · TypeScript Zero-Tolerance (Bölüm 2.1)**  
  Session types, AuthPort interface, tüm auth service'ler strict TypeScript ile yazılacak. Yeni hook/değer eklemelerinde `any` veya bastırma yapılmayacak.

## Story

**As a** YBIS user,  
**I want** Google hesabım ile giriş yapabilmek,  
**so that** uygulamayı kullanmaya başlayabilir ve verilerime erişebilirim.

---

## Context

Bu story, kullanıcıların Google OAuth ile giriş yapmasını sağlar. Supabase Auth'u backend olarak kullanır ama Port Architecture prensibiyle soyutlanmıştır. Login screen, Chat-based ana ekrana yönlendirme yapar.

**Dependencies:**
- Story 3.1 (Supabase setup) tamamlanmış olmalı
- Google OAuth configured
- `@ybis/auth` package ready

**References:**
- Architecture: `docs/Güncel/Architecture_better.md`
- Auth Flow: AD-015 in `DEVELOPMENT_LOG.md`

---

## Acceptance Criteria

1. **Login Screen UI**
   - Centered layout with YBIS logo
   - "Google ile Giriş Yap" button
   - Loading state (spinner) during auth
   - Error message display (toast/banner)

2. **AuthPort Package Structure**
   - `packages/auth/` package created
   - `AuthPort` interface defined
   - `SupabaseAuthAdapter` implemented
   - Unit tests for adapter (80%+ coverage)

3. **OAuth Flow Working**
   - Tap Google button → OAuth browser opens
   - Complete Google auth → Redirect to `ybis://auth-callback`
   - Session token saved in `expo-secure-store`
   - User redirected to main app (Chat screen)

4. **Session Management**
   - `authStore` (Zustand) holds session state
   - Session persisted across app restarts
   - Auto-login on app start (if valid session)

5. **Error Handling**
   - Network errors → Retry button
   - OAuth cancelled → Return to login
   - Invalid credentials → Clear error message

6. **Demo Mode Entry (Optional)**
   - “Demo Mode” butonu login ekranında görünür
   - Tıklandığında mock demo kullanıcısı ile uygulama açılır (mevcut demo store kullanımı)
   - Demo akışı açıkça “Demo” olarak etiketlenir ve gerçek auth port’una istek atmaz

---

## Tasks / Subtasks

### Task 1: AuthPort Package Setup (AC: 2)
- [ ] **T1.1** Create `packages/auth/package.json`
  ```json
  {
    "name": "@ybis/auth",
    "version": "0.1.0",
    "main": "src/index.ts",
    "dependencies": {
      "@supabase/supabase-js": "^2.47.10"
    }
  }
  ```
- [ ] **T1.2** Create `packages/auth/tsconfig.json` (composite: true)
- [ ] **T1.3** Create `packages/auth/src/ports/AuthPort.ts`
  ```typescript
  export interface AuthSession {
    accessToken: string;
    refreshToken: string;
    user: User;
    workspace: Workspace;
  }

  export interface User {
    id: string;
    email: string;
    displayName: string | null;
    avatarUrl: string | null;
  }

  export interface Workspace {
    id: string;
    name: string;
    ownerId: string;
  }

  export interface AuthPort {
    signInWithGoogle(): Promise<AuthSession>;
    signOut(): Promise<void>;
    getSession(): Promise<AuthSession | null>;
    onAuthStateChange(callback: (session: AuthSession | null) => void): () => void;
  }
  ```
- [ ] **T1.4** Create `packages/auth/src/adapters/SupabaseAuthAdapter.ts`
  - Implement `signInWithGoogle()` using Supabase OAuth
  - Implement `getSession()` with token refresh
  - Implement `onAuthStateChange()` listener
  - Handle errors (network, invalid token)
- [ ] **T1.5** Create unit tests `packages/auth/src/__tests__/SupabaseAuthAdapter.test.ts`
  - Mock Supabase client
  - Test sign in success
  - Test sign in errors
  - Test session retrieval

### Task 2: Login Screen UI (AC: 1)
- [ ] **T2.1** Create `apps/mobile/src/screens/LoginScreen.tsx`
  ```typescript
  import { YStack, Text, Button } from '@ybis/ui';
  import { GoogleIcon } from '@ybis/ui/icons';
  
  export function LoginScreen() {
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState<string | null>(null);
    
    const handleGoogleLogin = async () => {
      // Implement OAuth flow
    };
    
    return (
      <YStack flex={1} alignItems="center" justifyContent="center" padding="$4">
        <YStack gap="$6" maxWidth={400} width="100%">
          {/* Logo */}
          <YStack alignItems="center">
            <Text fontSize="$8" fontWeight="bold">YBIS</Text>
            <Text fontSize="$4" color="$gray11">AI Productivity Assistant</Text>
          </YStack>
          
          {/* Google Login Button */}
          <Button
            size="$5"
            onPress={handleGoogleLogin}
            disabled={loading}
            icon={<GoogleIcon size={24} />}
          >
            {loading ? 'Giriş yapılıyor...' : 'Google ile Giriş Yap'}
          </Button>
          
          {/* Error Display */}
          {error && (
            <Text color="$red10" textAlign="center">{error}</Text>
          )}
        </YStack>
      </YStack>
    );
  }
  ```
- [ ] **T2.2** Add Google icon to `@ybis/ui/icons`
- [ ] **T2.3** Add loading spinner (use Tamagui `Spinner`)

### Task 3: Auth Service Implementation (AC: 3, 4)
- [ ] **T3.1** Create `apps/mobile/src/services/auth.service.ts`
  ```typescript
  import { authPort } from '@ybis/auth';
  import * as SecureStore from 'expo-secure-store';
  
  export class AuthService {
    async signInWithGoogle(): Promise<void> {
      const session = await authPort.signInWithGoogle();
      await this.saveSession(session);
      // Navigate to main app
    }
    
    async saveSession(session: AuthSession): Promise<void> {
      await SecureStore.setItemAsync('auth_session', JSON.stringify(session));
    }
    
    async loadSession(): Promise<AuthSession | null> {
      const json = await SecureStore.getItemAsync('auth_session');
      return json ? JSON.parse(json) : null;
    }
    
    async signOut(): Promise<void> {
      await authPort.signOut();
      await SecureStore.deleteItemAsync('auth_session');
    }
  }
  ```
- [ ] **T3.2** Create Zustand store `apps/mobile/src/stores/authStore.ts`
  ```typescript
  import { create } from 'zustand';
  
  interface AuthState {
    session: AuthSession | null;
    loading: boolean;
    setSession: (session: AuthSession | null) => void;
    setLoading: (loading: boolean) => void;
  }
  
  export const useAuthStore = create<AuthState>((set) => ({
    session: null,
    loading: true,
    setSession: (session) => set({ session }),
    setLoading: (loading) => set({ loading }),
  }));
  ```
- [ ] **T3.3** Implement auto-login in `apps/mobile/app/_layout.tsx`
  ```typescript
  useEffect(() => {
    const checkSession = async () => {
      const session = await authService.loadSession();
      if (session) {
        authStore.setSession(session);
        router.replace('/(tabs)'); // Navigate to main app
      } else {
        authStore.setLoading(false);
      }
    };
    checkSession();
  }, []);
  ```

### Task 4: OAuth Deep Link Handling (AC: 3)
- [ ] **T4.1** Add deep link config to `app.json`
  ```json
  {
    "expo": {
      "scheme": "ybis",
      "android": {
        "intentFilters": [{
          "action": "VIEW",
          "data": [{ "scheme": "ybis" }]
        }]
      },
      "ios": {
        "bundleIdentifier": "com.ybis.mobile",
        "associatedDomains": ["applinks:ybis.app"]
      }
    }
  }
  ```
- [ ] **T4.2** Create `apps/mobile/app/auth-callback.tsx` (redirect handler)
  ```typescript
  import { useEffect } from 'react';
  import { useRouter } from 'expo-router';
  
  export default function AuthCallback() {
    const router = useRouter();
    
    useEffect(() => {
      // Supabase handles token exchange automatically
      // Just redirect to main app
      router.replace('/(tabs)');
    }, []);
    
    return null; // Or loading spinner
  }
  ```

### Task 5: Error Handling (AC: 5)
- [ ] **T5.1** Create `NetworkErrorBanner` component
  ```typescript
  export function NetworkErrorBanner({ error, onRetry }: Props) {
    return (
      <YStack padding="$3" backgroundColor="$red2" borderRadius="$4">
        <Text color="$red10">{error}</Text>
        <Button size="$3" onPress={onRetry} marginTop="$2">Tekrar Dene</Button>
      </YStack>
    );
  }
  ```
- [ ] **T5.2** Add error handling to LoginScreen
  - Network error → Show banner + retry
  - OAuth cancelled → Clear error, return to login
  - Invalid credentials → Show error message

### Task 6: Demo Mode CTA & Flow (AC: 6)
- [ ] **T6.1** Ek “Demo Modu” butonunu LoginScreen'e ekle (`@ybis/ui` Button + Demo etiketi)
- [ ] **T6.2** Demo butonu `useMockAuth.loginDemo()` fonksiyonunu tetikler, state güncellenir
- [ ] **T6.3** Demo akışına özel telemetry/event log ekleyerek gerçek auth çağrısını atlamadığını doğrula
- [ ] **T6.4** Demo ile giriş yapıldığında ana ekranda “Demo Mode” göstergesi çıkar

---

## Dev Notes

### Supabase OAuth Flow
1. User taps Google button
2. App calls `supabase.auth.signInWithOAuth({ provider: 'google' })`
3. Supabase opens OAuth browser
4. User completes Google auth
5. Google redirects to `ybis://auth-callback`
6. Supabase intercepts redirect, exchanges code for token
7. App receives session

### Token Storage Security
- Use `expo-secure-store` (encrypted keychain/keystore)
- Never store tokens in AsyncStorage (plain text)
- Never log tokens (Sentry masking)

### Session Refresh
- Supabase auto-refreshes tokens (60 min expiry)
- Adapter listens to refresh events
- authStore updated automatically

---

## Testing

### Manual Testing
- [ ] Tap Google button → OAuth browser opens
- [ ] Complete Google auth → Return to app
- [ ] Verify logged in (see main app)
- [ ] Kill app → Reopen → Auto-login works
- [ ] Logout → Return to login screen
- [ ] Login again → Works

### Unit Tests
```typescript
describe('SupabaseAuthAdapter', () => {
  it('should sign in with Google', async () => {
    const adapter = new SupabaseAuthAdapter(mockClient);
    const session = await adapter.signInWithGoogle();
    expect(session).toBeDefined();
    expect(session.user.email).toBe('test@example.com');
  });
});
```

---

## Files Created/Modified

### New Files
```
packages/auth/
├── package.json
├── tsconfig.json
├── src/
│   ├── index.ts
│   ├── ports/
│   │   └── AuthPort.ts
│   ├── adapters/
│   │   └── SupabaseAuthAdapter.ts
│   ├── types/
│   │   ├── AuthSession.ts
│   │   ├── User.ts
│   │   └── Workspace.ts
│   └── __tests__/
│       └── SupabaseAuthAdapter.test.ts

apps/mobile/src/
├── screens/
│   └── LoginScreen.tsx
├── services/
│   └── auth.service.ts
├── stores/
│   └── authStore.ts
└── components/
    └── NetworkErrorBanner.tsx

apps/mobile/app/
└── auth-callback.tsx
```

### Modified Files
```
apps/mobile/app/_layout.tsx (auto-login logic)
apps/mobile/app.json (deep link config)
packages/ui/src/icons/index.ts (add GoogleIcon)
```

---

## Dependencies & Blockers

**Dependencies:**
- Story 3.1 (Supabase setup) ✅ Must be complete
- Google OAuth credentials configured

**Blockers:**
- None

**Related Stories:**
- 4.2: Session Management (extends auto-login)
- 4.3: User Profile (uses session data)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-29 | 1.0 | Initial story creation | Copilot |

---

## Dev Agent Record

**Agent Model Used:** _[To be filled]_  
**Completion Notes:** _[To be filled]_  
**File List:** _[To be filled]_

---

## QA Results

_[To be filled by QA Agent]_
