# Story 3.2: Database Schema + RLS - Implementation Guide

**Status:** IN PROGRESS  
**Estimated:** 20 dakika  
**Date:** 2025-10-29

---

## ✅ WHAT WE'RE CREATING

```yaml
Tables (10):
  ✅ workspaces - User workspace isolation
  ✅ profiles - User metadata
  ✅ notes - Note management
  ✅ tasks - Task management
  ✅ flows - Workflow templates
  ✅ flow_executions - Flow run history
  ✅ flow_execution_logs - Step-by-step logs
  ✅ documents - RAG document uploads
  ✅ chunks - RAG embeddings (vector search)
  ✅ push_tokens - Push notification tokens

Security:
  ✅ RLS enabled on ALL tables
  ✅ 28 RLS policies (workspace isolation)
  ✅ Auto-create workspace on signup

Features:
  ✅ Full-text search (notes)
  ✅ Vector similarity search (RAG)
  ✅ Auto-updated timestamps
  ✅ Cascade deletes
```

---

## 📋 IMPLEMENTATION STEPS

### **STEP 1: Run Migration in Supabase (5 dakika)**

1. **Supabase Dashboard'a git:**
   - https://supabase.com/dashboard
   - YBIS projesini aç

2. **SQL Editor'a git:**
   ```
   Sol menü → SQL Editor (veya Database → SQL)
   ```

3. **Yeni Query Oluştur:**
   - **"New query"** butonuna tıkla

4. **SQL'i Yapıştır:**
   - `supabase/migrations/001_initial_schema.sql` dosyasındaki TÜMEL SQL'i kopyala
   - SQL Editor'a yapıştır

5. **Run:**
   - **"Run"** (veya Ctrl+Enter) tuşuna bas
   - İşlem ~10-15 saniye sürer

6. **Success Mesajı:**
   ```
   Success. No rows returned
   (ya da "Rows affected: 0")
   ```

---

### **STEP 2: Verify Tables (2 dakika)**

1. **Table Editor'a git:**
   ```
   Sol menü → Table Editor
   ```

2. **Tabloları kontrol et:**
   ```
   Görmelisin:
   ✅ workspaces
   ✅ profiles
   ✅ notes
   ✅ tasks
   ✅ flows
   ✅ flow_executions
   ✅ flow_execution_logs
   ✅ documents
   ✅ chunks
   ✅ push_tokens
   ```

3. **Bir tabloya tıkla (örn: tasks):**
   - Kolonları gör:
     - id, workspace_id, user_id, title, status, priority, due_date, etc.

---

### **STEP 3: Verify RLS Policies (2 dakika)**

1. **Authentication → Policies git:**
   ```
   Sol menü → Authentication → Policies
   ```

2. **Her tablo için 3-4 policy görmelisin:**
   - Read (SELECT)
   - Create (INSERT)
   - Update (UPDATE)
   - Delete (DELETE)

3. **Örnek (tasks tablosu):**
   ```
   ✅ Users can read tasks in their workspace
   ✅ Users can create tasks in their workspace
   ✅ Users can update their tasks
   ✅ Users can delete their tasks
   ```

---

### **STEP 4: Test with Sample Data (5 dakika)**

SQL Editor'da test query çalıştır:

```sql
-- Test 1: Create a test user (manuel - auth.users tablosu Supabase manage eder)
-- Bunu atlayabiliriz, signup ile otomatik olacak

-- Test 2: Check if workspace auto-created
SELECT * FROM workspaces LIMIT 1;
-- Şimdilik boş olabilir (user signup'tan sonra dolacak)

-- Test 3: Check vector extension
SELECT * FROM pg_extension WHERE extname = 'vector';
-- Result: Should show pgvector extension

-- Test 4: Test full-text search index
SELECT to_tsvector('english', 'This is a test note');
-- Result: Should return tsvector

-- Test 5: Check RLS is enabled
SELECT tablename, rowsecurity 
FROM pg_tables 
WHERE schemaname = 'public' AND tablename = 'tasks';
-- Result: rowsecurity should be 't' (true)
```

---

### **STEP 5: Verify Triggers (2 dakika)**

SQL Editor'da:

```sql
-- Check if triggers are created
SELECT 
  trigger_name, 
  event_object_table 
FROM information_schema.triggers 
WHERE trigger_schema = 'public'
ORDER BY event_object_table;

-- Should show:
-- update_workspaces_updated_at | workspaces
-- update_profiles_updated_at | profiles
-- update_notes_updated_at | notes
-- update_tasks_updated_at | tasks
-- ... etc
-- on_auth_user_created | users
```

---

## ✅ SUCCESS CRITERIA

```yaml
Story 3.2: Database Schema + RLS
Status: COMPLETE ✅

Verification:
  ✅ All 10 tables created
  ✅ All RLS policies active
  ✅ pgvector extension working
  ✅ Triggers created
  ✅ Indexes created
  ✅ Auto-workspace-creation function ready

Next: Story 3.3 (AuthPort Implementation)
```

---

## 🆘 TROUBLESHOOTING

**Error: "extension vector does not exist"**
→ Database → Extensions → pgvector ON yap

**Error: "function uuid_generate_v4() does not exist"**
→ Database → Extensions → uuid-ossp ON yap

**Tables bulamıyorum:**
→ Table Editor → Refresh yap (F5)

**RLS policies yok:**
→ Authentication → Policies → Tabloya tıkla

---

## 📝 FILES CREATED

```
C:\Projeler\YBIS\supabase\migrations\001_initial_schema.sql ✅
C:\Projeler\YBIS\docs\stories\3.2.database-schema-guide.md ✅
```

---

## 🎯 NEXT STEPS

**Bana şunu söyle:**
```
"SQL çalıştırdım, tablolar oluştu!"
```

**Sonra:**
- Story 3.3: AuthPort Implementation (Supabase Auth adapter kodlama)
- Story 3.4: DatabasePort Implementation (Supabase client kodlama)

---

**READY TO RUN SQL?** 🚀
