# Story 3.2: Database Schema + RLS - Implementation Guide

**Status:** IN PROGRESS  
**Estimated:** 20 dakika  
**Date:** 2025-10-29

---

## âœ… WHAT WE'RE CREATING

```yaml
Tables (10):
  âœ… workspaces - User workspace isolation
  âœ… profiles - User metadata
  âœ… notes - Note management
  âœ… tasks - Task management
  âœ… flows - Workflow templates
  âœ… flow_executions - Flow run history
  âœ… flow_execution_logs - Step-by-step logs
  âœ… documents - RAG document uploads
  âœ… chunks - RAG embeddings (vector search)
  âœ… push_tokens - Push notification tokens

Security:
  âœ… RLS enabled on ALL tables
  âœ… 28 RLS policies (workspace isolation)
  âœ… Auto-create workspace on signup

Features:
  âœ… Full-text search (notes)
  âœ… Vector similarity search (RAG)
  âœ… Auto-updated timestamps
  âœ… Cascade deletes
```

---

## ğŸ“‹ IMPLEMENTATION STEPS

### **STEP 1: Run Migration in Supabase (5 dakika)**

1. **Supabase Dashboard'a git:**
   - https://supabase.com/dashboard
   - YBIS projesini aÃ§

2. **SQL Editor'a git:**
   ```
   Sol menÃ¼ â†’ SQL Editor (veya Database â†’ SQL)
   ```

3. **Yeni Query OluÅŸtur:**
   - **"New query"** butonuna tÄ±kla

4. **SQL'i YapÄ±ÅŸtÄ±r:**
   - `supabase/migrations/001_initial_schema.sql` dosyasÄ±ndaki TÃœMEL SQL'i kopyala
   - SQL Editor'a yapÄ±ÅŸtÄ±r

5. **Run:**
   - **"Run"** (veya Ctrl+Enter) tuÅŸuna bas
   - Ä°ÅŸlem ~10-15 saniye sÃ¼rer

6. **Success MesajÄ±:**
   ```
   Success. No rows returned
   (ya da "Rows affected: 0")
   ```

---

### **STEP 2: Verify Tables (2 dakika)**

1. **Table Editor'a git:**
   ```
   Sol menÃ¼ â†’ Table Editor
   ```

2. **TablolarÄ± kontrol et:**
   ```
   GÃ¶rmelisin:
   âœ… workspaces
   âœ… profiles
   âœ… notes
   âœ… tasks
   âœ… flows
   âœ… flow_executions
   âœ… flow_execution_logs
   âœ… documents
   âœ… chunks
   âœ… push_tokens
   ```

3. **Bir tabloya tÄ±kla (Ã¶rn: tasks):**
   - KolonlarÄ± gÃ¶r:
     - id, workspace_id, user_id, title, status, priority, due_date, etc.

---

### **STEP 3: Verify RLS Policies (2 dakika)**

1. **Authentication â†’ Policies git:**
   ```
   Sol menÃ¼ â†’ Authentication â†’ Policies
   ```

2. **Her tablo iÃ§in 3-4 policy gÃ¶rmelisin:**
   - Read (SELECT)
   - Create (INSERT)
   - Update (UPDATE)
   - Delete (DELETE)

3. **Ã–rnek (tasks tablosu):**
   ```
   âœ… Users can read tasks in their workspace
   âœ… Users can create tasks in their workspace
   âœ… Users can update their tasks
   âœ… Users can delete their tasks
   ```

---

### **STEP 4: Test with Sample Data (5 dakika)**

SQL Editor'da test query Ã§alÄ±ÅŸtÄ±r:

```sql
-- Test 1: Create a test user (manuel - auth.users tablosu Supabase manage eder)
-- Bunu atlayabiliriz, signup ile otomatik olacak

-- Test 2: Check if workspace auto-created
SELECT * FROM workspaces LIMIT 1;
-- Åimdilik boÅŸ olabilir (user signup'tan sonra dolacak)

-- Test 3: Check vector extension
SELECT * FROM pg_extension WHERE extname = 'vector';
-- Result: Should show pgvector extension

-- Test 4: Test full-text search index
SELECT to_tsvector('english', 'This is a test note');
-- Result: Should return tsvector

-- Test 5: Check RLS is enabled
SELECT tablename, rowsecurity 
FROM pg_tables 
WHERE schemaname = 'public' AND tablename = 'tasks';
-- Result: rowsecurity should be 't' (true)
```

---

### **STEP 5: Verify Triggers (2 dakika)**

SQL Editor'da:

```sql
-- Check if triggers are created
SELECT 
  trigger_name, 
  event_object_table 
FROM information_schema.triggers 
WHERE trigger_schema = 'public'
ORDER BY event_object_table;

-- Should show:
-- update_workspaces_updated_at | workspaces
-- update_profiles_updated_at | profiles
-- update_notes_updated_at | notes
-- update_tasks_updated_at | tasks
-- ... etc
-- on_auth_user_created | users
```

---

## âœ… SUCCESS CRITERIA

```yaml
Story 3.2: Database Schema + RLS
Status: COMPLETE âœ…

Verification:
  âœ… All 10 tables created
  âœ… All RLS policies active
  âœ… pgvector extension working
  âœ… Triggers created
  âœ… Indexes created
  âœ… Auto-workspace-creation function ready

Next: Story 3.3 (AuthPort Implementation)
```

---

## ğŸ†˜ TROUBLESHOOTING

**Error: "extension vector does not exist"**
â†’ Database â†’ Extensions â†’ pgvector ON yap

**Error: "function uuid_generate_v4() does not exist"**
â†’ Database â†’ Extensions â†’ uuid-ossp ON yap

**Tables bulamÄ±yorum:**
â†’ Table Editor â†’ Refresh yap (F5)

**RLS policies yok:**
â†’ Authentication â†’ Policies â†’ Tabloya tÄ±kla

---

## ğŸ“ FILES CREATED

```
C:\Projeler\YBIS\supabase\migrations\001_initial_schema.sql âœ…
C:\Projeler\YBIS\docs\stories\3.2.database-schema-guide.md âœ…
```

---

## ğŸ¯ NEXT STEPS

**Bana ÅŸunu sÃ¶yle:**
```
"SQL Ã§alÄ±ÅŸtÄ±rdÄ±m, tablolar oluÅŸtu!"
```

**Sonra:**
- Story 3.3: AuthPort Implementation (Supabase Auth adapter kodlama)
- Story 3.4: DatabasePort Implementation (Supabase client kodlama)

---

**READY TO RUN SQL?** ğŸš€
