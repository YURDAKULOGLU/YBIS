# Story 3.1: Supabase Project Setup & Database Foundation

**Status:** Draft  
**Epic:** 3. Closed Beta Backend Infrastructure  
**Story Points:** 5  
**Priority:** P0 (Critical - Blocker)  
**Created:** 2025-10-29  
**Assigned To:** Dev Agent

---

## 🏛️ Anayasa Uyum Kontrolü (ZORUNLU)

- **YBIS Proje Anayasası · Port Architecture (Bölüm 3)**  
  Supabase'i doğrudan kullanmak yerine, `DatabasePort` ve `AuthPort` interface'leri üzerinden soyutlayacağım. Uygulama katmanları hiçbir zaman doğrudan Supabase SDK'yı import etmeyecek.

- **YBIS Çekirdek Mimari Prensipleri · Workspace Odaklı Veri Şeması (#5)**  
  Tüm tablolar `workspace_id` ile ilişkilendirilecek ve RLS politikaları bu temelde kurulacak. Şu anda her kullanıcı kendi workspace'ine sahip olacak, gelecekte multi-user workspace desteği eklenebilecek.

- **YBIS Proje Anayasası · TypeScript Zero-Tolerance (Bölüm 2.1)**  
  Tüm Supabase type tanımları strict mode'da yazılacak, `any` type kullanılmayacak.

## Story

**As a** backend developer,  
**I want** Supabase project'i kurulu ve temel database schema'sı hazır olsun,  
**so that** authentication ve data persistence için sağlam bir temel oluşturabilelim.

---

## Context

YBIS Closed Beta için Supabase'i BaaS (Backend as a Service) olarak kullanıyoruz. Bu story, Supabase project setup'ı, Google OAuth configuration'ı ve temel database schema'sını (workspaces, profiles, users) oluşturur.

**References:**
- Architecture: `docs/Güncel/Architecture_better.md`
- Tech Stack: `docs/Güncel/tech-stack.md`
- Port Catalog: `docs/YBIS_PROJE_ANAYASASI.md` (Section 8)

---

## Acceptance Criteria

1. **Supabase Project Setup**
   - Supabase organization "YBIS" oluşturulmuş
   - Production project `ybis-closed-beta-prod` kurulmuş
   - Development project `ybis-closed-beta-dev` kurulmuş
   - Environment variables `.env.local` ve Vercel'e eklenmiş

2. **Google OAuth Provider Configuration**
   - Google Cloud Console'da OAuth 2.0 credentials oluşturulmuş
   - Supabase Dashboard'da Google provider enabled
   - Redirect URI: `ybis://auth-callback` configured
   - Required scopes: `email`, `profile`, `calendar.events`, `calendar.settings.readonly`

3. **Database Schema - Core Tables**
   - `workspaces` table created with RLS
   - `profiles` table created with RLS
   - Database migrations tracked in `supabase/migrations/`

4. **Row Level Security (RLS) Policies**
   - `workspaces` table: Users can only access their own workspace
   - `profiles` table: Users can only access profiles in their workspace
   - All policies tested with different users

5. **Development Experience**
   - Local Supabase setup documented
   - Connection strings work from mobile app
   - Database can be accessed via Supabase Studio

---

## Tasks / Subtasks

### Task 1: Supabase Account & Projects (AC: 1)
- [ ] **T1.1** Create Supabase account (if not exists)
- [ ] **T1.2** Create organization "YBIS"
- [ ] **T1.3** Create project `ybis-closed-beta-prod`
  - Region: eu-west-1 (Ireland) - EU data compliance
  - Database password: Store in password manager
- [ ] **T1.4** Create project `ybis-closed-beta-dev`
  - Region: same as prod
  - Database password: Different from prod
- [ ] **T1.5** Copy API keys to `.env.local`
  ```
  SUPABASE_URL=https://xxx.supabase.co
  SUPABASE_ANON_KEY=eyJhbGc...
  SUPABASE_SERVICE_KEY=eyJhbGc... (only backend)
  ```
- [ ] **T1.6** Add environment variables to Vercel project

### Task 2: Google OAuth Configuration (AC: 2)
- [ ] **T2.1** Go to Google Cloud Console
- [ ] **T2.2** Create new project "YBIS Mobile"
- [ ] **T2.3** Enable Google Calendar API
- [ ] **T2.4** Create OAuth 2.0 Client ID
  - Application type: iOS + Android
  - Bundle ID: com.ybis.mobile
  - Redirect URI: `ybis://auth-callback`
- [ ] **T2.5** Copy Client ID and Client Secret
- [ ] **T2.6** In Supabase Dashboard → Authentication → Providers
  - Enable Google provider
  - Paste Client ID and Secret
  - Add redirect URI
- [ ] **T2.7** Test OAuth flow from Supabase dashboard

### Task 3: Database Schema Setup (AC: 3)
- [ ] **T3.1** Create `supabase/migrations/` directory in project root
- [ ] **T3.2** Create migration `20251029000001_create_workspaces_table.sql`
  ```sql
  CREATE TABLE workspaces (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    owner_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    name TEXT NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
  );

  CREATE INDEX idx_workspaces_owner ON workspaces(owner_id);
  ```
- [ ] **T3.3** Create migration `20251029000002_create_profiles_table.sql`
  ```sql
  CREATE TABLE profiles (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    workspace_id UUID NOT NULL REFERENCES workspaces(id) ON DELETE CASCADE,
    display_name TEXT,
    avatar_url TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(user_id, workspace_id)
  );

  CREATE INDEX idx_profiles_user ON profiles(user_id);
  CREATE INDEX idx_profiles_workspace ON profiles(workspace_id);
  ```
- [ ] **T3.4** Run migrations on dev database via Supabase Studio
- [ ] **T3.5** Verify tables created successfully

### Task 4: Row Level Security (RLS) Policies (AC: 4)
- [ ] **T4.1** Create migration `20251029000003_enable_rls_workspaces.sql`
  ```sql
  ALTER TABLE workspaces ENABLE ROW LEVEL SECURITY;

  -- Policy: Users can only see their own workspace
  CREATE POLICY "Users can view own workspace"
    ON workspaces FOR SELECT
    USING (owner_id = auth.uid());

  -- Policy: Users can update their own workspace
  CREATE POLICY "Users can update own workspace"
    ON workspaces FOR UPDATE
    USING (owner_id = auth.uid());

  -- Policy: Users can insert their own workspace
  CREATE POLICY "Users can create own workspace"
    ON workspaces FOR INSERT
    WITH CHECK (owner_id = auth.uid());
  ```
- [ ] **T4.2** Create migration `20251029000004_enable_rls_profiles.sql`
  ```sql
  ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;

  -- Policy: Users can see profiles in their workspace
  CREATE POLICY "Users can view profiles in workspace"
    ON profiles FOR SELECT
    USING (
      workspace_id IN (
        SELECT id FROM workspaces WHERE owner_id = auth.uid()
      )
    );

  -- Policy: Users can create profiles in their workspace
  CREATE POLICY "Users can create profiles in workspace"
    ON profiles FOR INSERT
    WITH CHECK (
      workspace_id IN (
        SELECT id FROM workspaces WHERE owner_id = auth.uid()
      )
    );

  -- Policy: Users can update profiles in their workspace
  CREATE POLICY "Users can update profiles in workspace"
    ON profiles FOR UPDATE
    USING (
      workspace_id IN (
        SELECT id FROM workspaces WHERE owner_id = auth.uid()
      )
    );
  ```
- [ ] **T4.3** Run RLS migrations
- [ ] **T4.4** Test RLS policies
  - Create test user A → workspace A
  - Create test user B → workspace B
  - Verify user A cannot access user B's workspace
  - Verify user A cannot access user B's profile

### Task 5: Auto-Create Workspace on Signup (AC: 3)
- [ ] **T5.1** Create Supabase Database Function
  ```sql
  CREATE OR REPLACE FUNCTION handle_new_user()
  RETURNS TRIGGER AS $$
  BEGIN
    -- Create default workspace for new user
    INSERT INTO workspaces (owner_id, name)
    VALUES (NEW.id, NEW.email || '''s Workspace');
    
    -- Create profile in that workspace
    INSERT INTO profiles (user_id, workspace_id, display_name, avatar_url)
    VALUES (
      NEW.id,
      (SELECT id FROM workspaces WHERE owner_id = NEW.id LIMIT 1),
      NEW.raw_user_meta_data->>'full_name',
      NEW.raw_user_meta_data->>'avatar_url'
    );
    
    RETURN NEW;
  END;
  $$ LANGUAGE plpgsql SECURITY DEFINER;
  ```
- [ ] **T5.2** Create trigger
  ```sql
  CREATE TRIGGER on_auth_user_created
    AFTER INSERT ON auth.users
    FOR EACH ROW
    EXECUTE FUNCTION handle_new_user();
  ```
- [ ] **T5.3** Test trigger: Create test user → verify workspace + profile auto-created

### Task 6: Documentation & Local Setup (AC: 5)
- [ ] **T6.1** Create `docs/backend/SUPABASE_SETUP.md`
  - Project URLs (prod, dev)
  - Environment variables
  - Migration workflow
  - RLS testing guide
- [ ] **T6.2** Add Supabase connection test to mobile app
  - Create simple utility: `testSupabaseConnection()`
  - Log connection status on app start (dev only)
- [ ] **T6.3** Document troubleshooting steps
  - Connection errors
  - RLS policy issues
  - Migration rollback

---

## Dev Notes

### Supabase Free Tier Limits
- Database: 500MB storage
- Realtime: 200 concurrent connections
- Auth: Unlimited users
- Storage: 1GB files
- Edge Functions: 500K invocations/month

**Mitigation:** Monitor usage via Supabase dashboard. Upgrade to Pro ($25/mo) if needed.

### Database Naming Conventions
- Tables: Plural, snake_case (`workspaces`, `user_profiles`)
- Columns: snake_case (`created_at`, `owner_id`)
- Foreign keys: `<table>_id` format (`workspace_id`, `user_id`)

### Migration Best Practices
- One migration per change
- Reversible migrations (include DOWN script)
- Test on dev before prod
- Keep migrations in version control

---

## Testing

### Manual Testing Checklist
- [ ] Create test user via Supabase dashboard
- [ ] Verify workspace auto-created
- [ ] Verify profile auto-created
- [ ] Test RLS: User A cannot access User B's data
- [ ] Test OAuth: Google login redirects correctly
- [ ] Test mobile connection: App can query database

### Integration Tests (Future Story)
- User signup → workspace + profile created
- RLS enforcement across different users
- Database connection from mobile app

---

## Files Created/Modified

### New Files
```
supabase/
├── migrations/
│   ├── 20251029000001_create_workspaces_table.sql
│   ├── 20251029000002_create_profiles_table.sql
│   ├── 20251029000003_enable_rls_workspaces.sql
│   ├── 20251029000004_enable_rls_profiles.sql
│   └── 20251029000005_auto_create_workspace_trigger.sql
└── config.toml (Supabase CLI config)

docs/backend/
└── SUPABASE_SETUP.md

.env.local (git-ignored)
```

### Modified Files
```
.gitignore (add .env.local, supabase/.branches)
README.md (add Supabase setup instructions)
```

---

## Dependencies & Blockers

**Dependencies:**
- Google Cloud Console access (OAuth credentials)
- Supabase account creation permissions

**Blockers:**
- None

**Related Stories:**
- 3.2: Database Schema (extends this schema)
- 4.1: Login Screen (uses OAuth configured here)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-29 | 1.0 | Initial story creation | Copilot |

---

## Dev Agent Record

**Agent Model Used:** _[To be filled by Dev Agent]_

**Debug Log References:** _[To be filled by Dev Agent]_

**Completion Notes:**
- _[To be filled by Dev Agent]_

**File List:**
- _[To be filled by Dev Agent]_

---

## QA Results

_[To be filled by QA Agent]_
